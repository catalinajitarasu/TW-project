<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizare Profil</title>
    <link rel="stylesheet" href="user.css">
    <script>
        function checklLoggedIn(){
            var userData = JSON.parse(localStorage.getItem("userData"))
            if(!userData || !userData.token){
                alert("You are not logged in!")
                var currentPath = window.location.pathname;
                var newPath = currentPath.substring(0, currentPath.lastIndexOf("/", currentPath.lastIndexOf("/") - 1));
                newPath += "/login.html";
                window.location.href = newPath;
            }
            else{
                console.log(userData)
            }
        }
        
        document.addEventListener("DOMContentLoaded", function() {
        // redirect if already logged in
        checklLoggedIn()
    });

        
    // todo: change according to register
    document.addEventListener("DOMContentLoaded", function() {         
        // register request
        document.getElementById("updateForm").addEventListener("submit", function(event) {
            event.preventDefault(); // prevent the form from submitting the default way
            var newEmail = document.getElementById("newEmail").value;
            var oldEmail = document.getElementById("oldEmail").value;
            var firstName = document.getElementById("firstName").value;
            var lastName = document.getElementById("lastName").value;
            var password = document.getElementById("password").value;
            var confirmPassword = document.getElementById("confirmPassword").value;
            var age = document.getElementById("age").value;
            var gender = document.getElementById("gender").value;
            var city = document.getElementById("city").value;
            var country = document.getElementById("country").value;
            var diet = document.getElementById("diet").value;
            var allergies = document.getElementById("allergies").value;
            var preferences = document.getElementById("preferences").value;
            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }
            
            fetch("http://localhost:8000/user/update", {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    newEmail, oldEmail, firstName, lastName, password, age, gender,
                    city, country, diet, allergies, preferences
                })
            }).then(response => {
                console.log(response)
                if (response.ok) {
                    console.log("Data submitted successfully");
                    return response.json();
                } else {
                    // alert()
                    throw new Error("Failed to submit data");
                }
            }).then(data => {
                console.log(data);
                alert("User updated. Go to login!")
                localStorage.clear()
                var currentPath = window.location.pathname;
                var newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + 'login.html';
                window.location.href = newPath;
                // window.location.href ='../home-page.html'
            }).catch(error => {
                alert(error)
                console.error("Error:", error);
            });
        });
    });
    
    </script>
</head>
<body>
    <div class="container">
        <h2>Actualizare Profil</h2>
        <form id="updateForm">
            <div class="input-group">
                <label for="firstName">First name:</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="input-group">
                <label for="lastName">Last name:</label>
                <input type="text" id="lastName" name="LastName" required>
            </div>
            <div class="input-group">
                <label for="oldEmail">Current email address:</label>
                <input type="oldEmail" id="oldEmail" name="oldEmail" required>
            </div>
            <div class="input-group">
                <label for="newEmail">New email address:</label>
                <input type="newEmail" id="newEmail" name="newEmail" required>
            </div>
            <div class="input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="input-group">
                <label for="confirmPassword">Confirm password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            <div class="input-group">
                <label for="age">Vârstă:</label>
                <input type="number" id="age" name="age" min="1" required>
            </div>
            <div class="input-group">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender" required>
                    <option value="" disabled selected hidden>Select an option</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label for="city">City:</label>
                <input type="text" id="city" name="city" required>
            </div>
            <div class="input-group">
                <label for="country">Țară:</label>
                <input type="text" id="country" name="country" required>
            </div>
            <div class="input-group">
                <label for="diet">Diet:</label>
                <select id="diet" name="diet" required>
                    <option value="" disabled selected hidden>Select an option</option>
                    <option value="omnivor">Omnivor</option>
                    <option value="carnivor">Carnivor</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="vegan">Vegan</option>
                    <option value="raw-vegan">Raw-Vegan</option>
                    <option value="pescatarian">Pescatarian</option>
                </select>
            </div>
            <div class="input-group">
                <label for="allergies">Allergies:</label>
                <input type="text" id="allergies" name="allergies" placeholder="Ex. gluten, lactose, peanuts">
            </div>
            <div class="input-group">
                <label for="preferences">Preferences:</label>
                <input type="text" id="preferences" name="preferences" placeholder="Ex. italian, asiatic">
            </div>
            <button type="submit">Update</button>
        </form>
    </div>
</body>
</html>
    